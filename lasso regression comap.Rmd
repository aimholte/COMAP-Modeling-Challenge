---
title: "Modeling_AJ"
author: "A.J. Imholte"
date: "February 10, 2018"
output: html_document
---

```{r}
library(tidyr)
RealData <- spread(ProblemCData, key=MSN, value=Data)
```

```{r}
library(ggplot2)
RealData$GPP <- RealData$REPRB / RealData$TEPRB
RealData$GPC <- RealData$RETCB / RealData$TETCB

gg1 <- ggplot(RealData, aes(x = Year, y = GPC)) +
  geom_line(aes(col = StateCode))
plot(gg1)

gg <- ggplot(RealData, aes(x = Year, y = GPP)) +
  geom_line(aes(col = StateCode))
plot(gg)

gg2 <- ggplot(RealData, aes(x = Year, y = REPRB)) +
  geom_line(aes(col = StateCode))
plot(gg2)

gg3 <- ggplot(RealData, aes(x = Year, y = RETCB)) +
  geom_line(aes(col = StateCode))
plot(gg3)
```

```{r}
# Total Energy Consumption - TETCB

#train <- sample(1:nrow(x), nrow(x)/2)
#test <- (-train)
#y.test <- y[-train]
train <- 1:(nrow(RealData) / 2)
trainingdata <- RealData[train]
testingdata <- RealData[-train]
```

```{r}
#Lasso

# library(glmnet)
# LassoMod <- glmnet(x[train,], y[train], alpha = 1)
# plot(LassoMod)
# LassoMod.pred <- predict(LassoMod, s = 207164, newx = x[-train, ])
# mse <- mean((LassoMod.pred-sample(y.test,20)^2))
```



```{r}
# Lasso Regression with 10k cross-validation

library(glmnet)
x <- model.matrix(GPC ~., RealData)[,-1]
y <- RealData$GPC
train <- sample(1:nrow(x), nrow(x)/2)
y <- sample(y, 120)
test <- (-train)
y.test <- y[test]
y <- sample(y, 120)
lasso.mod <- glmnet(x[train,],y[train],alpha=1)
cv.out <- cv.glmnet(x[train,], y[train], alpha=1, nfolds=3)
plot(cv.out)
bestlam <- cv.out$lambda.min
bestlam
lasso.pred <- predict(lasso.mod,s=bestlam,newx = x[test,])
mean((lasso.pred - y[test])^2)
```
```{r}
out <- glmnet(x,y,alpha=1)
lasso.coef <- predict(out, type = "coefficients", s=bestlam)
lasso.coef
```


```{r}
library(glmnet)
x <- model.matrix(REPRB ~., RealData)[,-1]
y <- RealData$TETCB
train <- sample(1:nrow(x), nrow(x)/2)
y <- sample(y, 120)
test <- (-train)
y.test <- y[test]
y <- sample(y, 120)
lasso.mod <- glmnet(x[train,],y[train],alpha=1)
cv.out <- cv.glmnet(x[train,], y[train], alpha=1, nfolds=60)
plot(cv.out)
bestlam <- cv.out$lambda.min
bestlam
lasso.pred <- predict(lasso.mod,s=bestlam,newx = x[test,])
mse.ridge <- mean((lasso.pred - y[test])^2)
```
```{r}
library(glmnet)
x <- model.matrix(REPRB ~., RealData)[,-1]
y <- RealData$TETCB
train <- sample(1:nrow(x), nrow(x)/2)
y <- sample(y, 120)
test <- (-train)
y.test <- y[test]
y <- sample(y, 120)
lasso.mod <- glmnet(x[train,],y[train],alpha=0)
cv.out <- cv.glmnet(x[train,], y[train], alpha=0, nfolds=60)
plot(cv.out)
bestlam <- cv.out$lambda.min
bestlam
lasso.pred <- predict(lasso.mod,s=bestlam,newx = x[test,], exact = T)
mse.ols <- mean((lasso.pred - y[test])^2)
```



```{r}
out <- glmnet(x,y,alpha=1)
lasso.coef <- predict(out, type = "coefficients", s=bestlam)
lasso.coef
```
```{r}
# A linear model with selected model terms...
lm.mod <- lm(RealData$REPRB ~ RealData$CLHCK + RealData$DKEIB + 
    RealData$ELIMD + RealData$HYICB + RealData$LUACD + RealData$LUICD + 
    RealData$LUTCD + RealData$NUEGV + RealData$NUETV + RealData$P1TCD + 
    RealData$USICB + RealData$WXICV)
summary(lm.mod)

lm.mod2 <- lm(RealData$REPRB ~ RealData$CLHCK + RealData$DKEIB + 
    RealData$ELIMD + RealData$HYICB + RealData$LUACD + RealData$NUEGV + RealData$P1TCD + 
    RealData$USICB + RealData$WXICV)
summary(lm.mod2)

#lm.mod3 <- lm(log(RealData$REPRB) ~ log(RealData$CLHCK) + log(RealData$DKEIB) + log(RealData$ELIMB) + log(RealData$HYICB) +
#                                          log(RealData$LUACD) + log(RealData$NUEGV) + log(RealData$P1TCD) + log(RealData$USICB) + log(RealData$WXICV))

# Fix this later
```
```{r}
varstoremove <- c("ABICP", "ARICP", "ABICP", "ARICP", "ARTCP", "ARTXP", "AVACP", "AVTCP", "AVTXP", "AVTXP", "CCEXP", "CCIMP", 'BMTCB',
                  "CCNIP","CLACP","CLCCP","CLEIP","CLICP","CLKCP","CLOCP","CLPRP","CLRCP","CLTCP","CLTXP","COICP", 'COPRK', "DFCCP",
                  "DFICP", "DFRCP","DFTCP", "DFTXP", "DKEIP", "ELEXP", "ELIMP","ELNIP", 'EMFDB', "EMTCP","ESACP", "ESCCP", "ESICP",
                  "ESRCP", "ESTCP",	"ESTXP", "FNICP",	'FOICP', 'FSICP',	'GEEGP', "GETXV", 'GECCB', 'GEEGB', 'GEEGP', 'GEICB', 'GERCB', 'GETCB', 'GETXB', 'GOCCB', 'GORCB', 'HYCCB', 'HYCCP', 'HYEGB', 'HYEGP','HYICB', 'HYICP', 'HYTCB',	'HYTCP', 'HYTXB', 'HYTXP', 'HYTXV',
                  'JFACP', 'JFTCP', 'JFTXP','JKACP','JKTCP', 'JNACP', 'JNTCP','KSCCP', 'KSICP', 'KSRCP', 'KSTCP',	'KSTXP','LGACP', 'LGCCP', 'LGICP', 'LGRCP', 'LGTCP', 'LGTXP',	'LUACP','LUICP','LUTCD','LUTCP', 'LUTCV',	'LUTXP','MBICP', 'MGACP',	'MGCCP','MGICP','MGTCP', 'MGTXP', 'MSICP', 'NAICP', 'NGACP', 'NGCCP',	'NGEIP', 'NGICP', 'NGLPP', 'NGMPP', 'NGPZP', 'NGRCP',	'NGTCP','NGTXP','NGVHP', 'NUEGP', 'NUETP', 'P1ICP', 'P1TCP', 'P1TXP', 'PAACP', 'PACCP', 'PAEIP', 'PAICP', 'PAPRP', 'PARCP', 'PATCP', 'PATXP', 'PATXV',	'PCCCP', 'PCCB', 'PCEIP','PCICP','PCTCP',	'PLICP','POICP','POTCP','POTXP','PPICP','RFACP','RFCCP','RFEIP','RFICP','RFTCP','RFTXP','SGICP','SNICP','SOEGP','SOEGB','SOHCB', 'SOTCB', 'SOTXB','UOICP',	'USICP', 'WDCCB', 'WDEIB', 'WDICB', 'WDRCB', 'WDRCD', 'WDRCP', 'WDRCV', 'WDRSB', 'WDRXB', 'WWCCB', 'WWCCD', 'WWCCV', 'WWCSB', 'WWCXB', 'WWEIB', 'WWEID', 'WWEIV', 'WWICB', 'WWICD', 'WWICV', 'WWISB', 'WWIXB', 'WWTCB', 'WWTCD', 'WWTCV', 'WWTXB', 'WWTXD', 'WWTXV', 'WSCCB', 'WSEIB', 'WSICB','WXICP','WYEG', 'WYEGB', 'WYEGP', 'WYTCB','REPRB', 'ROPRB', 'CLICV' ,'GPP','GPC', 'PCCCD', 'PCCCB', 'PCCCV', 'NUEGB', 'NUETB', 'NUEGV', 'JNACB', 'JNACP','JNTCB','JNTCP', 'WXICD', 'WXICP', 'WXICV')

cleandata <- data.frame(RealData)
cleandata <- cleandata[ , !names(cleandata) %in% varstoremove]
train <- 1:(nrow(cleandata) / 2)
trainingdata <- cleandata[train,]
testingdata <- cleandata[-train,]
```


```{r}
#Pseodocode
# solution list
# all model list
# r2 list
#For i in range from 1 to max variable count
  #For j in range from 1 to al variables
    #estimate consumption with solution plus one additional variable
    #determine the best model with r2
  #add this model to the model list
  #add the term to the solution so we can start with it next time
```


```{r}
modsolutions <- c()
variablesused <- c('MGACB')
for(j in 2:10){
  for(i in 3:length(vars)){
    adr2list <- c()
    modlist <- c()
    var <- vars[i]
    #lm.mod <- lm(RETCB ~ get(var), data = cleandata)
    plm.mod <- plm(RETCB ~ get(variablesused) + get(var), data = cleandata, index = c("StateCode", "Year"), model = "within")
    adr2 <- r.squared(plm.mod, dfcor =  TRUE)
    adr2list[j] <- adr2
    modlist[j] <- plm.mod
  }
  maxr2 <- which.max(adr2list)
  variablesused[i] <- vars[maxr2]
  modsolutions[i] <- modlist[maxr2]
}
```

```{r}
adr2list <- c()
modlist <- c()
vars <- colnames(cleandata)
vars <- vars[-331]
vars[331]
  for(i in 3:length(vars)){
    var <- vars[i]
    #lm.mod <- lm(RETCB ~ get(var), data = cleandata)
    plm.mod <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV + PATXB + CLICD + NGACD + CLKCV + get(var), data = cleandata, index = c("StateCode", "Year"), model = "within")
    adr2 <- r.squared(plm.mod, dfcor =  TRUE)
    adr2list[i] <- adr2
    modlist[i] <- plm.mod
  }
r2max <- which.max(adr2list)
adr2list[r2max]
var <- vars[r2max]
var
```
```{r}
plm.1 <- plm(RETCB ~ MGACB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.1$
plm.2 <- plm(RETCB ~ MGACB + FFTCB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.3 <- plm(RETCB ~ MGACB + FFTCB + TETCB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.4 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.5 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.6 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.7 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV + PATXB, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.8 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV + PATXB + CLICD, data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.9 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV + PATXB + CLICD + NGACD , data = cleandata, index = c("StateCode", "Year"), model = "within")
plm.10 <- plm(RETCB ~ MGACB + FFTCB + TETCB + ELNIB + ELISB + NUETV + PATXB + CLICD + NGACD + CLKCV, data = cleandata, index = c("StateCode", "Year"), model = "within")
summary(plm.1)
summary(plm.2)
summary(plm.3)
summary(plm.4)
summary(plm.5)
summary(plm.6)
summary(plm.7)
summary(plm.8)
summary(plm.9)
summary(plm.10)
```
```{r}
Cp <- function(RSS, resid, n) {
  return((1 / n) * (RSS + 2 * var(resid)^2))
}
cplist <- c(Cp(6.9252e+11, plm.1$residuals, 200), Cp(5.3631e+11, plm.2$residuals, 200), Cp(4.2249e+11, plm.3$residuals, 200),
            Cp(3.0887e+11, plm.5$residuals, 200), Cp(1.1184e+11, plm.6$residuals, 160), Cp(8.5299e+10, plm.7$residuals, 160),
            Cp(7.4283e+10, plm.8$residuals, 160), Cp(6.9246e+10, plm.9$residuals, 160), Cp(6.3984e+10, plm.10$residuals, 160))
rsqlist <- c(r.squared(plm.1, dfcor = TRUE), r.squared(plm.2, dfcor = TRUE), r.squared(plm.3, dfcor = TRUE),
             r.squared(plm.4, dfcor = TRUE), r.squared(plm.5, dfcor = TRUE), r.squared(plm.6, dfcor = TRUE),
             r.squared(plm.7, dfcor = TRUE), r.squared(plm.8, dfcor = TRUE), r.squared(plm.9, dfcor = TRUE),
             r.squared(plm.10, dfcor = TRUE))
numbervars <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
par(mfrow = c(1,2))
plot(rsqlist, ylab = "Adjusted R Squared", xlab = "Number of Variables", type = "o")
plot(cplist, ylab = "Cp", xlab = "Number of Variables", type = "o")
```



```{r}
# Let's try best subset selection and see if results differ..., create a subset of the data
library(leaps)
subsetdata <- na.omit(cleandata)
regfit.full <- regsubsets(RETCB ~., data = cleandata, really.big = T, method = "forward")
regfit.summary <- summary(regfit.full)
regfit.summary$rsq
```
```{r}
par(mfrow = c(2,2))
plot(regfit.summary$rss, xlab = "Number of Variables", ylab = "RSS", type = "l")
plot(regfit.summary$adjr2, xlab = "Number of Variables", ylab = "Adjusted RSq", type = "l")
adjr2.max <- which.max(regfit.summary$adjr2)
points(adjr2.max, regfit.summary$adjr2[adjr2.max], col = "red", cex=2, pch=20)
```
```{r}
plot(regfit.summary$cp, xlab="Number of Variables", ylab = "Cp", type = "l")
cp.min <- which.min(regfit.summary$cp)
points(cp.min, regfit.summary$cp[cp.min], col = "red", cex=2,pch=20)
bic.min <- which.min(regfit.summary$bic)
plot(regfit.summary$bic, xlab="Number of Variables", ylab = "BIC", type = "l")
points(bic.min, regfit.summary$bic[bic.min], col="red", cex=2, pch=20)
```
```{r}
plot(regfit.full, scale = "r2")
plot(regfit.full, scale = "adjr2")
plot(regfit.full, scale = "Cp")
plot(regfit.full, scale = "bic")
```





